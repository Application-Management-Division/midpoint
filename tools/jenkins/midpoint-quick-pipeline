def verbose = 0
try {
    verbose = Integer.parseInt(params.VERBOSE ?: '0')
} catch (Exception e) { /* ignored */ }

podTemplate(
        activeDeadlineSeconds: 7200,
        idleMinutes: 1,
        // No need for secret volume, no mvn deploy done here.
        workspaceVolume: dynamicPVC(requestsSize: "10Gi"),
        containers: [
                containerTemplate(name: 'jnlp',
                        image: 'jenkins/inbound-agent:4.13-2-alpine',
                        runAsUser: '0',
                        resourceRequestCpu: '1',
                        resourceLimitCpu: '1',
                        resourceRequestMemory: '1Gi',
                        resourceLimitMemory: '1Gi'),
                containerTemplate(name: 'maven',
                        image: "${params.BUILDER_IMAGE ?: 'maven:3.8.5-openjdk-11-slim'}",
                        runAsUser: '0',
                        ttyEnabled: true,
                        command: 'cat',
                        resourceRequestCpu: "${params.BUILDER_CPU ?: '4'}",
                        resourceLimitCpu: "${params.BUILDER_CPU ?: '4'}",
                        resourceRequestMemory: '6Gi',
                        resourceLimitMemory: '6Gi') // by default -Xmx4g is set in main POM
        ]
) {
    node(POD_LABEL) {
        stage("checkout") {
            git branch: "${params.BRANCH ?: 'master'}",
                    url: 'https://github.com/Evolveum/midpoint.git'
        }
        stage("build") {
            container('maven') {
                sh """#!/bin/bash -ex
                    if [ "${verbose}" -ge 1 ]
                    then
                        id
                        env | sort
                        mvn --version
                    fi

                    mvn -B -ntp -Dmaven.test.failure.ignore clean install -P -dist -DintegrationTestSuite=fast
                """

                step([$class: 'Publisher', reportFilenamePattern: '**/testng-results.xml'])
            }
        }
    }
}
